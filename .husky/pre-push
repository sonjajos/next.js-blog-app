#!/usr/bin/env sh
set -e
. "$(dirname -- "$0")/_/husky.sh"

read local_ref local_sha remote_ref remote_sha
REMOTE_BRANCH=${remote_ref#refs/heads/}
BRANCH=$(git symbolic-ref --short HEAD)

if [ "$REMOTE_BRANCH" = "main" ]; then
  echo "‚ùå Pushing directly to '$REMOTE_BRANCH' is NOT allowed! Please merge 'develop' or create new hotfix/ branch."
  exit 1
fi
if [ "$REMOTE_BRANCH" = "develop" ]; then
  echo "‚ÄºÔ∏è Pushing directly to '$REMOTE_BRANCH' - this push may get rejected by GH ‚ÄºÔ∏è"
  echo "üü† Running tests..."
  npm test
  echo "‚è∫Ô∏è Running build command..."
  npm run build
else
  if echo "$BRANCH" | grep -Eq '^(feature|fix|improvement|hotfix|chore|refactor|test|docs)/'; then
    echo "‚úÖ Branch name '$BRANCH' is valid."
    echo "üü† Running tests..."
    npm test
    echo "‚è≠Ô∏è Skipping build check on branch: $BRANCH"
  else
    echo "‚ùå Invalid branch name: '$BRANCH'"
    echo "üîí Branch must start with one of: feature/, fix/, improvement/, hotfix/, chore/, refactor/, test/, docs/"
    exit 1
  fi
fi
